name: Emacs startup CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  startup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate repository layout
        run: |
          # The repo directory itself must be named ".emacs.d"
          if [ "$(basename "$PWD")" != ".emacs.d" ]; then
            echo "::error::The repository root must be a directory named '.emacs.d'."
            exit 1
          fi
          # It must contain init.el
          if [ ! -f "./init.el" ]; then
            echo "::error::Missing './init.el' at the repo root."
            exit 1
          fi
          # It must contain early-init.el
          if [ ! -f "./early-init.el" ]; then
            echo "::error::Missing './early-init.el' at the repo root."
            exit 1
          fi

      - name: Install Emacs and deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            emacs-nox \
            git \
            xclip \
            cmake libtool-bin build-essential pkg-config

      - name: Print Emacs version
        run: emacs --version

      - name: Startup test
        run: |
          export HOME="$(dirname "$PWD")"
          emacs --batch \
            --eval '(setq debug-on-error t inhibit-startup-screen t)' \
            --eval '(setq user-emacs-directory (expand-file-name "~/.emacs.d/"))' \
            -l "$HOME/.emacs.d/early-init.el" \
            -l "$HOME/.emacs.d/init.el" \
            --eval '(message "Init loaded OK")'

      - name: Byte-compile configuration
        run: |
          export HOME="$(dirname "$PWD")"
          emacs --batch \
            -l "$HOME/.emacs.d/early-init.el" \
            -l "$HOME/.emacs.d/init.el" \
            --eval '(setq debug-on-error t)' \
            --eval '(byte-recompile-directory (expand-file-name "~/.emacs.d") 0 t)'
