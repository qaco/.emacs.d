name: Emacs startup CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  startup:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate repository layout
        run: |
          if [ "$(basename "$PWD")" != ".emacs.d" ]; then
            echo "::error::The repository root must be a directory named '.emacs.d'."
            exit 1
          fi
          required_files=(init.el early-init.el standalone.el)
          for f in "${required_files[@]}"; do
            if [ ! -f "./$f" ]; then
              echo "::error::Missing './$f' at the repo root."
              exit 1
            fi
          done

      - name: Install Emacs and deps (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            emacs-nox \
            git \
            xclip \
            xvfb \
            cmake libtool-bin build-essential pkg-config

      - name: Install Emacs and deps (macOS)
        if: runner.os == 'macOS'
        run: brew install emacs cmake libtool

      - name: Print Emacs version
        run: emacs --version

      - name: Startup test (init.el)
        run: |
          export HOME="$(dirname "$PWD")"
          emacs --batch \
            --eval '(setq debug-on-error t inhibit-startup-screen t)' \
            --eval '(setq user-emacs-directory (expand-file-name "~/.emacs.d/"))' \
            -l "$HOME/.emacs.d/early-init.el" \
            -l "$HOME/.emacs.d/init.el"

      - name: Startup test (standalone.el)
        run: |
          export HOME="$(dirname "$PWD")"
          emacs --batch \
            -L "$HOME/.emacs.d" \
            --eval '(setq debug-on-error t inhibit-startup-screen t)' \
            --eval '(setq user-emacs-directory (expand-file-name "~/.emacs.d/"))' \
            -l "$HOME/.emacs.d/standalone.el"

      - name: Byte-compile configuration
        run: |
          export HOME="$(dirname "$PWD")"
          emacs --batch \
            -l "$HOME/.emacs.d/early-init.el" \
            -l "$HOME/.emacs.d/init.el" \
            --eval '(setq debug-on-error t)' \
            --eval '(byte-recompile-directory (expand-file-name "~/.emacs.d") 0 t)'

      - name: Clipboard test (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          export HOME="$(dirname "$PWD")"
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 &
          sleep 1
          script -q -c "emacs \
            -l \"$HOME/.emacs.d/early-init.el\" \
            -l \"$HOME/.emacs.d/init.el\" \
            --eval '(with-temp-buffer (insert \"emacs-clipboard-test\") (beginning-of-buffer) (kill-line))' \
            --eval '(kill-emacs)'" /dev/null
          result=$(xclip -selection clipboard -o 2>&1 || true)
          if [ "$result" != "emacs-clipboard-test" ]; then
            echo "::error::Clipboard test failed. Expected 'emacs-clipboard-test', got '$result'"
            exit 1
          fi

      - name: Clipboard test (macOS)
        if: runner.os == 'macOS'
        run: |
          export HOME="$(dirname "$PWD")"
          script -q /dev/null emacs -nw \
            -l "$HOME/.emacs.d/early-init.el" \
            -l "$HOME/.emacs.d/init.el" \
            --eval '(with-temp-buffer (insert "emacs-clipboard-test") (beginning-of-buffer) (kill-line))' \
            --eval '(kill-emacs)'
          result=$(pbpaste)
          if [ "$result" != "emacs-clipboard-test" ]; then
            echo "::error::Clipboard test failed. Expected 'emacs-clipboard-test', got '$result'"
            exit 1
          fi
