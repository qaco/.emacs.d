name: Emacs startup CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  startup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate repository layout
        run: |
          if [ "$(basename "$PWD")" != ".emacs.d" ]; then
            echo "::error::The repository root must be a directory named '.emacs.d'."
            exit 1
          fi
          required_files=(init.el early-init.el standalone.el)
          for f in "${required_files[@]}"; do
            if [ ! -f "./$f" ]; then
              echo "::error::Missing './$f' at the repo root."
              exit 1
            fi
          done

      - name: Install Emacs and deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            emacs-nox \
            git \
            xclip \
            cmake libtool-bin build-essential pkg-config

      - name: Print Emacs version
        run: emacs --version

      - name: Startup test (init.el)
        run: |
          export HOME="$(dirname "$PWD")"
          emacs --batch \
            --eval '(setq debug-on-error t inhibit-startup-screen t)' \
            --eval '(setq user-emacs-directory (expand-file-name "~/.emacs.d/"))' \
            -l "$HOME/.emacs.d/early-init.el" \
            -l "$HOME/.emacs.d/init.el"

      - name: Startup test (standalone.el)
        run: |
          export HOME="$(dirname "$PWD")"
          emacs --batch \
            -L "$HOME/.emacs.d" \
            --eval '(setq debug-on-error t inhibit-startup-screen t)' \
            --eval '(setq user-emacs-directory (expand-file-name "~/.emacs.d/"))' \
            -l "$HOME/.emacs.d/standalone.el"

      - name: Byte-compile configuration
        run: |
          export HOME="$(dirname "$PWD")"
          emacs --batch \
            -l "$HOME/.emacs.d/early-init.el" \
            -l "$HOME/.emacs.d/init.el" \
            --eval '(setq debug-on-error t)' \
            --eval '(byte-recompile-directory (expand-file-name "~/.emacs.d") 0 t)'
